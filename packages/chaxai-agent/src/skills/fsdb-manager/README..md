# FSDB 文件存储系统目录结构详解

## Agent Skills

本目录包含 FSDB 管理的 Agent Skill，可用于 Claude AI 助手。

### 技能文件

| 文件 | 说明 |
|------|------|
| [SKILL.md](SKILL.md) | Agent Skill 主文件，包含完整使用说明 |
| [scripts/](scripts/) | 配套脚本集合 |
| [references/](references/) | 参考文档和规范 |

### 快速使用

1. **创建表结构**：使用 `scripts/create-table.sh` 脚本
2. **数据管理**：使用 `scripts/manage-data.sh` 脚本
3. **验证结构**：使用 `scripts/validate-schema.sh` 脚本
4. **详细规范**：参阅 `references/fsdb-specification.md`

## 1. 概述

FSDB（File Store Database）是一种基于文件系统的轻量级数据存储方案，通过特定的目录结构和元数据文件来组织和管理数据。该系统将数据以文件形式存储，支持三种类型的数据表：基础表、拓展表和资源表。

### 1.1 目录命名规范

所有 FSDB 数据目录均以 `[FSDB]` 为前缀，用于标识该目录属于 FSDB 存储系统。FSDB 目录下仅包含以下三种类型的数据目录：

- `[struct]` 开头的目录：基础表数据目录
- `[extend]` 开头的目录：拓展表数据目录
- `[resource]` 开头的目录：资源表数据目录

其他目录或者文件将被忽略，不会被 FSDB 系统识别和管理。

## 2. 基础表数据目录（[struct]）

### 2.1 定义与用途

基础表是 FSDB 系统的核心数据存储单元，用于存储系统中最基础、最核心的数据实体。每个基础表对应一个独立的业务概念或数据实体。

### 2.2 目录结构

```
[struct]<数据名>/
├── {key1}.json
├── {key2}.json
├── {key3}.json
└── .info.meta
```

### 2.3 数据文件规范

- **文件格式**：独立的 JSON 文件
- **文件命名**：`{key}.json`，其中 `key` 是该条数据的唯一标识符
- **数据内容**：每条数据以 JSON 对象形式存储

### 2.4 元数据文件（.info.meta）

每个 `[struct]` 目录下必须包含一个 `.info.meta` 文件，该文件采用 JSON Schema 格式，用于描述该目录下所有 JSON 数据文件的结构。

`.info.meta` 文件包含以下信息：

- 数据字段的定义
- 每个字段的数据类型
- 字段的业务描述
- 字段的约束条件（如必填、取值范围等）

## 3. 拓展表数据目录（[extend]）

### 3.1 定义与用途

拓展表用于存储与基础表相关联的扩展数据。与基础表不同的是，拓展表中的数据可以通过特定字段引用基础表的数据，实现表之间的关联和数据扩展。

### 3.2 目录结构

```
[extend]<数据名>/
├── {key1}.json
├── {key2}.json
├── {key3}.json
├── .info.meta
└── .extend.meta
```

### 3.3 数据文件规范

- **文件格式**：独立的 JSON 文件
- **文件命名**：`{key}.json`，其中 `key` 是该条数据的唯一标识符
- **数据内容**：每条数据以 JSON 对象形式存储，其中某些字段的值指向基础表的 `key`

### 3.4 元数据文件

#### 3.4.1 .info.meta 文件

与 `[struct]` 目录相同，每个 `[extend]` 目录下必须包含一个 `.info.meta` 文件，采用 JSON Schema 格式描述数据结构。

**重要约束**：如果某个字段在 `.extend.meta` 中被声明为对基础表的引用，那么该字段在 `.info.meta` 中定义的数据类型必须为 `string`。

#### 3.4.2 .extend.meta 文件

每个 `[extend]` 目录下必须包含一个 `.extend.meta` 文件，该文件采用 JSONL（JSON Lines）格式，用于声明该拓展表中哪些字段引用了基础表的数据，以及引用关系的描述。

**文件格式说明**：

每行一个独立的 JSON 对象，包含 struct、field 和 desc 三个字段，用于描述一个引用关系。

```json
{"field": "<字段名>", "struct": "<引用的基础表名>", "desc": "<引用关系描述>"}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| field | string | 是 | 拓展表中存储引用关系的字段名 |
| struct | string | 是 | 被引用的基础表名称 |
| desc | string | 否 | 对该引用关系的业务描述 |

## 4. 资源表数据目录（[resource]）

### 4.1 定义与用途

资源表用于存储系统中的非结构化或半结构化数据，如图片、音频、视频、文档等二进制或文本资源文件。

### 4.2 目录结构

```
[resource]<数据名>/
├── {key1}.{ext1}
├── {key2}.{ext2}
├── {key3}.{ext3}
└── .desc.meta
```

### 4.3 数据文件规范

- **文件格式**：任意类型的文件（由扩展名决定）
- **文件命名**：`{key}.{ext}`，其中：
  - `key` 是该条数据的唯一标识符
  - `ext` 是文件的扩展名，用于标识文件类型
- **数据内容**：可以是任何类型的文件内容

### 4.4 元数据文件（.desc.meta）

每个 `[resource]` 目录下必须包含一个 `.desc.meta` 文件，该文件采用 Markdown 格式，用于描述该目录下存储的资源的相关信息。

`.desc.meta` 文件通常包含以下内容：

- 资源的用途和业务场景
- 资源的存储规范和限制
- 资源的命名约定
- 资源的管理策略

## 5. 目录层级关系

FSDB 系统的目录层级关系如下：

```
[FSDB]<数据库名>/
├── [struct]<基础表名1>/
│   ├── {key1}.json
│   ├── {key2}.json
│   └── .info.meta
├── [extend]<拓展表名1>/
│   ├── {key1}.json
│   ├── {key2}.json
│   ├── .info.meta
│   └── .extend.meta
└── [resource]<资源表名1>/
    ├── {key1}.{ext1}
    ├── {key2}.{ext2}
    └── .desc.meta
```

## 6. 数据关联关系

### 6.1 引用规则

拓展表通过 `.extend.meta` 文件声明对基础表的引用关系。这种引用关系通过以下机制实现：

1. 在 `.extend.meta` 中声明引用字段的名称和目标基础表
2. 在拓展表的 JSON 数据中，该字段存储目标基础表数据的 `key` 值
3. 系统可以通过该 `key` 值查询并关联对应的基础表数据

### 6.2 多级引用

一个拓展表可以引用多个不同的基础表，通过在 `.extend.meta` 文件中定义多行 JSON 记录来实现。每行记录表示一个独立的引用关系。

### 6.3 引用完整性

由于拓展表中的引用字段存储的是基础表的 `key` 值，因此需要确保：

- 引用的基础表必须存在
- 引用的 `key` 值必须在基础表中存在对应的数据
- 当基础表数据被删除时，需要处理拓展表中的引用（具体策略由应用层决定）

## 7. 最佳实践

### 7.1 命名规范

- 使用有意义的名称命名数据表，避免使用无意义的字符
- `key` 值应具有唯一性和可读性，生成策略不做约束，只要保证在表数据中唯一，并且可以作为文件名的字符串
- 资源文件的扩展名应准确反映文件类型

### 7.2 元数据编写

- `.info.meta` 应完整描述所有字段，包括字段含义、数据类型、约束条件等
- `.extend.meta` 中的 `desc` 字段应清晰说明引用的业务含义
- `.desc.meta` 应详细说明资源的用途、管理方式和使用限制

### 7.3 数据组织

- 相关的基础表和拓展表应组织在同一个 FSDB 目录下
- 对于大型资源文件，建议按类型或日期进一步子目录分类
- 定期清理无效的 `key` 和 orphaned 引用
